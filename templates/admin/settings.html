{% extends "admin/base.html" %}

{% block title %}Settings{% endblock %}

{% block content %}
<div class="section active">
  <div class="card">
    <div class="card-title">âš™ï¸ Settings</div>
    
    {% if error %}
    <div style="margin-top: 20px; padding: 12px; background-color: #fee2e2; color: #991b1b; border-radius: 6px; margin-bottom: 20px;">
      âœ— {{ error }}
    </div>
    {% endif %}
    
    {% if success %}
    <div style="margin-top: 20px; padding: 12px; background-color: #d1fae5; color: #065f46; border-radius: 6px; margin-bottom: 20px;">
      âœ“ {{ success }}
    </div>
    {% endif %}

    <!-- Time Settings Section -->
    <div style="margin-top: 20px; padding: 20px; background: #fef3c7; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #f59e0b;">
      <h3 style="margin-bottom: 15px; color: #1f2937;">â° Attendance Time Settings</h3>
      <p style="color: #6b7280; margin-bottom: 20px; font-size: 14px;">
        Configure the time windows for attendance tracking. These settings determine when employees can time in/out and when they are considered late.
      </p>
      
      <form method="POST" action="{{ url_for('admin.settings') }}" id="time-settings-form">
        <input type="hidden" name="action" value="save_time_settings">
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
          <!-- Morning Time-In -->
          <div style="padding: 15px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
            <h4 style="margin: 0 0 15px 0; color: #1f2937; font-size: 16px;">ğŸŒ… Morning Time-In</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
              <div>
                <label style="display: block; margin-bottom: 5px; font-size: 13px; color: #6b7280;">Start Time:</label>
                <input type="time" name="morning_in_start" value="{{ time_settings.morning_in_start or '06:00' }}" required
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
              </div>
              <div>
                <label style="display: block; margin-bottom: 5px; font-size: 13px; color: #6b7280;">Late After:</label>
                <input type="time" name="morning_in_late" value="{{ time_settings.morning_in_late or '08:00' }}" required
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
              </div>
              <div>
                <label style="display: block; margin-bottom: 5px; font-size: 13px; color: #6b7280;">Window End:</label>
                <input type="time" name="morning_in_window_end" value="{{ time_settings.morning_in_window_end or '10:00' }}" required
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
              </div>
            </div>
            <p style="margin: 10px 0 0 0; font-size: 12px; color: #6b7280;">
              Employees can time in from start time until window end. Time-in after "Late After" is considered late.
            </p>
          </div>
          
          <!-- Lunch Break -->
          <div style="padding: 15px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
            <h4 style="margin: 0 0 15px 0; color: #1f2937; font-size: 16px;">ğŸ½ï¸ Lunch Break</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              <div>
                <label style="display: block; margin-bottom: 5px; font-size: 13px; color: #6b7280;">Time-Out Start:</label>
                <input type="time" name="lunch_out_start" value="{{ time_settings.lunch_out_start or '11:00' }}" required
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
              </div>
              <div>
                <label style="display: block; margin-bottom: 5px; font-size: 13px; color: #6b7280;">Time-Out End:</label>
                <input type="time" name="lunch_out_end" value="{{ time_settings.lunch_out_end or '13:00' }}" required
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
              </div>
            </div>
            <p style="margin: 10px 0 0 0; font-size: 12px; color: #6b7280;">
              Time window for lunch break time-out.
            </p>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
          <!-- Afternoon Time-In -->
          <div style="padding: 15px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
            <h4 style="margin: 0 0 15px 0; color: #1f2937; font-size: 16px;">ğŸŒ† Afternoon Time-In</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
              <div>
                <label style="display: block; margin-bottom: 5px; font-size: 13px; color: #6b7280;">Start Time:</label>
                <input type="time" name="afternoon_in_start" value="{{ time_settings.afternoon_in_start or '12:16' }}" required
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
              </div>
              <div>
                <label style="display: block; margin-bottom: 5px; font-size: 13px; color: #6b7280;">Late After:</label>
                <input type="time" name="afternoon_in_late" value="{{ time_settings.afternoon_in_late or '13:00' }}" required
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
              </div>
              <div>
                <label style="display: block; margin-bottom: 5px; font-size: 13px; color: #6b7280;">Window End:</label>
                <input type="time" name="afternoon_in_window_end" value="{{ time_settings.afternoon_in_window_end or '14:00' }}" required
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
              </div>
            </div>
            <p style="margin: 10px 0 0 0; font-size: 12px; color: #6b7280;">
              Employees can time in from start time until window end. Time-in after "Late After" is considered late.
            </p>
          </div>
          
          <!-- End of Day -->
          <div style="padding: 15px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
            <h4 style="margin: 0 0 15px 0; color: #1f2937; font-size: 16px;">ğŸŒ™ End of Day</h4>
            <div>
              <label style="display: block; margin-bottom: 5px; font-size: 13px; color: #6b7280;">Time-Out Start (Onwards):</label>
              <input type="time" name="time_out_start" value="{{ time_settings.time_out_start or '17:00' }}" required
                     style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
            </div>
            <p style="margin: 10px 0 0 0; font-size: 12px; color: #6b7280;">
              Employees can time out from this time onwards for end of work day.
            </p>
          </div>
        </div>
        
        <div style="text-align: right;">
          <button type="submit" 
                  style="padding: 12px 24px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px;">
            ğŸ’¾ Save Time Settings
          </button>
        </div>
      </form>
    </div>

    <!-- Auto-Refresh Settings Section -->
    <div style="margin-top: 20px; padding: 20px; background: #f0f9ff; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #3b82f6;">
      <h3 style="margin-bottom: 15px; color: #1f2937;">ğŸ”„ Auto-Refresh Settings</h3>
      <p style="color: #6b7280; margin-bottom: 20px; font-size: 14px;">
        Configure automatic data refresh for Dashboard and Attendance pages. When enabled, data will update automatically without manual refresh.
      </p>
      
      <div style="display: grid; grid-template-columns: 2fr 2fr 1fr; gap: 15px; align-items: end;">
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">Auto-Refresh Status:</label>
          <div style="display: flex; align-items: center; gap: 10px;">
            <label style="display: flex; align-items: center; cursor: pointer; font-size: 14px;">
              <input type="checkbox" id="auto-refresh-enabled" checked style="width: 20px; height: 20px; margin-right: 8px; cursor: pointer;">
              <span id="auto-refresh-status-text">Enabled</span>
            </label>
          </div>
        </div>
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">Refresh Interval (seconds):</label>
          <select id="auto-refresh-interval" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
            <option value="15000">15 seconds</option>
            <option value="30000" selected>30 seconds</option>
            <option value="60000">1 minute</option>
            <option value="120000">2 minutes</option>
            <option value="300000">5 minutes</option>
          </select>
        </div>
        <div>
          <button type="button" id="save-auto-refresh-btn" 
                  style="width: 100%; padding: 10px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
            Save Settings
          </button>
        </div>
      </div>
      
      <div id="auto-refresh-save-message" style="margin-top: 15px; display: none; padding: 10px; border-radius: 6px; font-size: 14px;"></div>
    </div>

    <!-- Holiday Section -->
    <div style="margin-top: 20px; padding: 20px; background: #f9fafb; border-radius: 8px; margin-bottom: 30px;">
      <h3 style="margin-bottom: 15px; color: #1f2937;">ğŸ‰ Mark Holiday</h3>
      <p style="color: #6b7280; margin-bottom: 20px; font-size: 14px;">
        Mark all active employees as present for a holiday. This will automatically create attendance records 
        with standard times (8:00 AM - 5:00 PM) for all employees on the selected date.
      </p>
      
      <form method="POST" action="{{ url_for('admin.settings') }}" style="display: grid; grid-template-columns: 2fr 2fr 1fr; gap: 15px; align-items: end;">
        <input type="hidden" name="action" value="mark_holiday">
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">Holiday Date:</label>
          <input type="date" name="holiday_date" required 
                 style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
        </div>
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">Reason (Optional):</label>
          <input type="text" name="reason" value="Holiday" placeholder="e.g., National Holiday, Special Holiday"
                 style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
        </div>
        <div>
          <button type="submit" 
                  style="width: 100%; padding: 10px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
            Mark Holiday
          </button>
        </div>
      </form>
    </div>

    <!-- Suspension Section -->
    <div style="padding: 20px; background: #fef3c7; border-radius: 8px; margin-bottom: 30px;">
      <h3 style="margin-bottom: 15px; color: #1f2937;">âš ï¸ Mark Suspension</h3>
      <p style="color: #6b7280; margin-bottom: 20px; font-size: 14px;">
        Mark all active employees as present for a sudden suspension or work stoppage. This will automatically 
        create attendance records with standard times (8:00 AM - 5:00 PM) for all employees on the selected date.
      </p>
      
      <form method="POST" action="{{ url_for('admin.settings') }}" style="display: grid; grid-template-columns: 2fr 2fr 1fr; gap: 15px; align-items: end;">
        <input type="hidden" name="action" value="mark_suspension">
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">Suspension Date:</label>
          <input type="date" name="suspension_date" required 
                 style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
        </div>
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">Reason (Optional):</label>
          <input type="text" name="reason" value="Suspension" placeholder="e.g., Work Suspension, Emergency"
                 style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
        </div>
        <div>
          <button type="submit" 
                  style="width: 100%; padding: 10px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">
            Mark Suspension
          </button>
        </div>
      </form>
    </div>

    <div style="margin-top: 30px; padding: 15px; background: #eff6ff; border-left: 4px solid #3b82f6; border-radius: 4px;">
      <p style="margin: 0; color: #1e40af; font-size: 14px;">
        <strong>Note:</strong> When marking holidays or suspensions, all active employees will be automatically 
        marked as "Present" with standard working hours. Existing attendance records for the selected date will be updated.
      </p>
    </div>
  </div>
</div>

<script>
// Auto-Refresh Settings Management
document.addEventListener('DOMContentLoaded', () => {
    // Load saved settings
    const savedEnabled = localStorage.getItem('autoRefreshEnabled');
    const savedInterval = localStorage.getItem('autoRefreshInterval');
    
    const enabledCheckbox = document.getElementById('auto-refresh-enabled');
    const intervalSelect = document.getElementById('auto-refresh-interval');
    const statusText = document.getElementById('auto-refresh-status-text');
    const saveBtn = document.getElementById('save-auto-refresh-btn');
    const messageDiv = document.getElementById('auto-refresh-save-message');
    
    // Set saved values
    if (savedEnabled !== null) {
        enabledCheckbox.checked = savedEnabled === 'true';
        updateStatusText();
    }
    
    if (savedInterval !== null) {
        intervalSelect.value = savedInterval;
    }
    
    // Update status text when checkbox changes
    enabledCheckbox.addEventListener('change', updateStatusText);
    
    function updateStatusText() {
        statusText.textContent = enabledCheckbox.checked ? 'Enabled' : 'Disabled';
        statusText.style.color = enabledCheckbox.checked ? '#10b981' : '#6b7280';
    }
    
    // Save settings
    saveBtn.addEventListener('click', () => {
        const enabled = enabledCheckbox.checked;
        const interval = intervalSelect.value;
        
        localStorage.setItem('autoRefreshEnabled', enabled);
        localStorage.setItem('autoRefreshInterval', interval);
        
        // Show success message
        messageDiv.style.display = 'block';
        messageDiv.style.backgroundColor = '#d1fae5';
        messageDiv.style.color = '#065f46';
        messageDiv.textContent = 'âœ“ Auto-refresh settings saved successfully!';
        
        // Hide message after 3 seconds
        setTimeout(() => {
            messageDiv.style.display = 'none';
        }, 3000);
        
        // Restart auto-refresh with new settings (no page reload needed)
        if (window.location.pathname.includes('/admin/dashboard') || 
            window.location.pathname.includes('/admin/attendance')) {
            // Stop current auto-refresh and restart with new settings
            if (typeof stopAutoRefresh === 'function') {
                stopAutoRefresh();
            }
            if (typeof startAutoRefresh === 'function') {
                setTimeout(() => {
                    startAutoRefresh();
                }, 500);
            }
        }
    });
    
    // Initialize status text
    updateStatusText();
});
</script>

{% endblock %}
