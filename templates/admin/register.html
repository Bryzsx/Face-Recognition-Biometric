{% extends "admin/base.html" %}

{% block title %}+ Register Employee{% endblock %}

{% block content %}
<div class="section active">
  <form id="registerForm" method="POST" action="{{ url_for('admin.register') }}">
    
    <!-- Personal Information -->
    <div class="register-card">
      <h5>Personal Information</h5>
      <div class="form-grid">
        <div>
          <label>Full Name *</label>
          <input type="text" name="full_name" required>
        </div>
        <div>
          <label>Employee ID *</label>
          <input type="text" name="employee_id" required>
        </div>
        <div>
          <label>Address</label>
          <input type="text" name="address">
        </div>
        <div>
          <label>Place of Birth</label>
          <input type="text" name="place_of_birth">
        </div>
        <div>
          <label>Blood Type</label>
          <select name="blood_type">
            <option value="">Select</option>
            <option value="A+">A+</option>
            <option value="A-">A-</option>
            <option value="B+">B+</option>
            <option value="B-">B-</option>
            <option value="AB+">AB+</option>
            <option value="AB-">AB-</option>
            <option value="O+">O+</option>
            <option value="O-">O-</option>
          </select>
        </div>
        <div>
          <label>Date of Birth</label>
          <input type="date" name="date_of_birth">
        </div>
        <div>
          <label>Gender</label>
          <select name="gender">
            <option value="">Select</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div>
          <label>Civil Status</label>
          <select name="civil_status">
            <option value="">Select</option>
            <option value="Single">Single</option>
            <option value="Married">Married</option>
            <option value="Divorced">Divorced</option>
            <option value="Widowed">Widowed</option>
          </select>
        </div>
        <div>
          <label>Age</label>
          <input type="number" name="age" min="18" max="100">
        </div>
      </div>
    </div>

    <!-- Contact & Education -->
    <div class="register-card">
      <h5>Contact & Education</h5>
      <div class="form-grid">
        <div>
          <label>Contact Number</label>
          <input type="tel" name="contact_number">
        </div>
        <div>
          <label>Email</label>
          <input type="email" name="email">
        </div>
        <div>
          <label>Course</label>
          <input type="text" name="course">
        </div>
        <div>
          <label>Entity / Office</label>
          <input type="text" name="entity_office">
        </div>
      </div>
    </div>

    <!-- Government & Identification Numbers -->
    <div class="register-card">
      <h5>Government & Identification Numbers</h5>
      <div class="form-grid">
        <div>
          <label>BP Number</label>
          <input type="text" name="bp_number">
        </div>
        <div>
          <label>PhilHealth Number</label>
          <input type="text" name="philhealth_number">
        </div>
        <div>
          <label>Pag-IBIG Number</label>
          <input type="text" name="pagibig_number">
        </div>
        <div>
          <label>TIN</label>
          <input type="text" name="tin">
        </div>
        <div>
          <label>ID Number</label>
          <input type="text" name="id_number">
        </div>
      </div>
    </div>

    <!-- Employment Information -->
    <div class="register-card">
      <h5>Employment Information</h5>
      <div class="form-grid">
        <div>
          <label>Position</label>
          <input type="text" name="position">
        </div>
        <div>
          <label>Salary Grade</label>
          <input type="text" name="salary_grade">
        </div>
        <div>
          <label>Basic Salary</label>
          <input type="number" name="basic_salary" step="0.01">
        </div>
        <div>
          <label>Department</label>
          <input type="text" name="department">
        </div>
        <div>
          <label>Place of Assignment</label>
          <input type="text" name="place_of_assignment">
        </div>
        <div>
          <label>Original Place of Assignment</label>
          <input type="text" name="original_place_of_assignment">
        </div>
        <div>
          <label>Item Number</label>
          <input type="text" name="item_number">
        </div>
      </div>
    </div>

    <!-- Appointment & Service Records -->
    <div class="register-card">
      <h5>Appointment & Service Records</h5>
      <div class="form-grid">
        <div>
          <label>Date Appointed</label>
          <input type="date" name="date_appointed">
        </div>
        <div>
          <label>Date of Last Promotion</label>
          <input type="date" name="date_of_last_promotion">
        </div>
        <div>
          <label>Date of Separation</label>
          <input type="date" name="date_of_separation">
        </div>
        <div>
          <label>Employment Status</label>
          <select name="employment_status">
            <option value="">Select</option>
            <option value="Permanent">Permanent</option>
            <option value="Temporary">Temporary</option>
            <option value="Contractual">Contractual</option>
            <option value="Casual">Casual</option>
          </select>
        </div>
        <div>
          <label>Eligibility</label>
          <input type="text" name="eligibility">
        </div>
      </div>
    </div>

    <!-- Facial Capture -->
    <div class="register-card facial-capture-section">
      <h5>Facial Capture</h5>
      <div class="facial-capture-container">
        <div class="capture-slots">
          <div class="capture-slot" id="slot-0">
            <div class="slot-icon">✓</div>
          </div>
          <div class="capture-slot" id="slot-1">
            <div class="slot-icon">✓</div>
          </div>
          <div class="capture-slot" id="slot-2">
            <div class="slot-icon">✓</div>
          </div>
          <div class="capture-slot" id="slot-3">
            <div class="slot-icon">✓</div>
          </div>
          <div class="capture-slot" id="slot-4">
            <div class="slot-icon">✓</div>
          </div>
          <div class="capture-slot" id="slot-5">
            <div class="slot-icon">✓</div>
          </div>
        </div>
        <div class="camera-preview-container">
          <video id="videoPreview" autoplay playsinline style="display: none;"></video>
          <canvas id="captureCanvas" style="display: none;"></canvas>
          <div id="cameraPlaceholder" class="camera-placeholder">
            <p>Click "Capture Photo" to start camera</p>
          </div>
        </div>
        <button type="button" id="captureBtn" class="capture-photo-btn">Capture Photo</button>
      </div>
      <input type="hidden" name="face_images" id="faceImagesInput">
    </div>

    <!-- Submit Button -->
    <div class="register-actions">
      <button type="submit" class="register-submit-btn">Register Employee</button>
    </div>

    {% if error %}
    <div class="error-message" style="margin-top: 20px; padding: 15px; background: #fee; color: #c33; border-radius: 8px; border: 2px solid #c33; font-weight: 600;">
      <strong>⚠️ Registration Failed:</strong> {{ error }}
    </div>
    {% endif %}
  </form>
</div>

<script>
let stream = null;
let capturedImages = [];
let currentSlot = 0;

const video = document.getElementById('videoPreview');
const canvas = document.getElementById('captureCanvas');
const captureBtn = document.getElementById('captureBtn');
const cameraPlaceholder = document.getElementById('cameraPlaceholder');
const faceImagesInput = document.getElementById('faceImagesInput');

// Start camera when Capture Photo button is clicked
captureBtn.addEventListener('click', async () => {
  if (stream) {
    // Camera is already running, capture photo
    capturePhoto();
  } else {
    // Start camera
    try {
      stream = await navigator.mediaDevices.getUserMedia({ 
        video: { 
          facingMode: 'user',
          width: { ideal: 640 },
          height: { ideal: 480 }
        } 
      });
      video.srcObject = stream;
      video.style.display = 'block';
      cameraPlaceholder.style.display = 'none';
      captureBtn.textContent = 'Capture Photo';
    } catch (error) {
      alert('Error accessing camera: ' + error.message);
      console.error('Camera error:', error);
    }
  }
});

function capturePhoto() {
  if (!stream) return;

  // Set canvas dimensions to match video
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  
  // Draw video frame to canvas
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0);
  
  // Convert to base64
  const imageData = canvas.toDataURL('image/jpeg', 0.8);
  
  // Store captured image
  if (currentSlot < 6) {
    capturedImages[currentSlot] = imageData;
    
    // Mark slot as captured
    const slot = document.getElementById(`slot-${currentSlot}`);
    slot.classList.add('captured');
    slot.style.backgroundImage = `url(${imageData})`;
    slot.style.backgroundSize = 'cover';
    slot.style.backgroundPosition = 'center';
    
    currentSlot++;
    
    // Update hidden input
    faceImagesInput.value = JSON.stringify(capturedImages.filter(img => img !== undefined));
    
    // If all slots filled, stop camera
    if (currentSlot >= 6) {
      stopCamera();
      captureBtn.textContent = 'All Photos Captured';
      captureBtn.disabled = true;
    }
  }
}

function stopCamera() {
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
    stream = null;
    video.style.display = 'none';
    cameraPlaceholder.style.display = 'block';
  }
}

// Stop camera when form is submitted
document.getElementById('registerForm').addEventListener('submit', function(e) {
  stopCamera();
  
  // Validate required fields
  const fullName = document.querySelector('input[name="full_name"]').value.trim();
  const employeeId = document.querySelector('input[name="employee_id"]').value.trim();
  
  if (!fullName) {
    e.preventDefault();
    alert('Please enter Full Name');
    document.querySelector('input[name="full_name"]').focus();
    return false;
  }
  
  if (!employeeId) {
    e.preventDefault();
    alert('Please enter Employee ID');
    document.querySelector('input[name="employee_id"]').focus();
    return false;
  }
  
  // Show loading state
  const submitBtn = document.querySelector('.register-submit-btn');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Registering...';
  
  // Allow form to submit
  return true;
});

// Stop camera when page is unloaded
window.addEventListener('beforeunload', () => {
  stopCamera();
});
</script>
{% endblock %}
