{% extends "admin/base.html" %}

{% block title %}Edit Employee{% endblock %}

{% block content %}
<div class="section active">
  <form id="editForm" method="POST" action="{{ url_for('edit_employee', employee_id=employee.id) }}">
    
    <!-- Personal Information -->
    <div class="register-card">
      <h5>Personal Information</h5>
      <div class="form-grid">
        <div>
          <label>Full Name *</label>
          <input type="text" name="full_name" value="{{ employee.full_name or '' }}" required>
        </div>
        <div>
          <label>Employee ID *</label>
          <input type="text" name="employee_id" value="{{ employee.employee_code or '' }}" required readonly style="background: #f3f4f6; cursor: not-allowed;">
          <small style="color: #6b7280; font-size: 12px;">Employee ID cannot be changed</small>
        </div>
        <div>
          <label>Address</label>
          <input type="text" name="address" value="{{ employee.address or '' }}">
        </div>
        <div>
          <label>Place of Birth</label>
          <input type="text" name="place_of_birth" value="{{ employee.place_of_birth or '' }}">
        </div>
        <div>
          <label>Blood Type</label>
          <select name="blood_type">
            <option value="">Select</option>
            <option value="A+" {% if employee.blood_type == 'A+' %}selected{% endif %}>A+</option>
            <option value="A-" {% if employee.blood_type == 'A-' %}selected{% endif %}>A-</option>
            <option value="B+" {% if employee.blood_type == 'B+' %}selected{% endif %}>B+</option>
            <option value="B-" {% if employee.blood_type == 'B-' %}selected{% endif %}>B-</option>
            <option value="AB+" {% if employee.blood_type == 'AB+' %}selected{% endif %}>AB+</option>
            <option value="AB-" {% if employee.blood_type == 'AB-' %}selected{% endif %}>AB-</option>
            <option value="O+" {% if employee.blood_type == 'O+' %}selected{% endif %}>O+</option>
            <option value="O-" {% if employee.blood_type == 'O-' %}selected{% endif %}>O-</option>
          </select>
        </div>
        <div>
          <label>Date of Birth</label>
          <input type="date" name="date_of_birth" value="{{ employee.date_of_birth or '' }}">
        </div>
        <div>
          <label>Gender</label>
          <select name="gender">
            <option value="">Select</option>
            <option value="Male" {% if employee.gender == 'Male' %}selected{% endif %}>Male</option>
            <option value="Female" {% if employee.gender == 'Female' %}selected{% endif %}>Female</option>
            <option value="Other" {% if employee.gender == 'Other' %}selected{% endif %}>Other</option>
          </select>
        </div>
        <div>
          <label>Civil Status</label>
          <select name="civil_status">
            <option value="">Select</option>
            <option value="Single" {% if employee.civil_status == 'Single' %}selected{% endif %}>Single</option>
            <option value="Married" {% if employee.civil_status == 'Married' %}selected{% endif %}>Married</option>
            <option value="Divorced" {% if employee.civil_status == 'Divorced' %}selected{% endif %}>Divorced</option>
            <option value="Widowed" {% if employee.civil_status == 'Widowed' %}selected{% endif %}>Widowed</option>
          </select>
        </div>
        <div>
          <label>Age</label>
          <input type="number" name="age" min="18" max="100" value="{{ employee.age or '' }}">
        </div>
      </div>
    </div>

    <!-- Contact & Education -->
    <div class="register-card">
      <h5>Contact & Education</h5>
      <div class="form-grid">
        <div>
          <label>Contact Number</label>
          <input type="tel" name="contact_number" value="{{ employee.contact_number or '' }}">
        </div>
        <div>
          <label>Email</label>
          <input type="email" name="email" value="{{ employee.email or '' }}">
        </div>
        <div>
          <label>Course</label>
          <input type="text" name="course" value="{{ employee.course or '' }}">
        </div>
        <div>
          <label>Entity / Office</label>
          <input type="text" name="entity_office" value="{{ employee.entity_office or '' }}">
        </div>
      </div>
    </div>

    <!-- Government & Identification Numbers -->
    <div class="register-card">
      <h5>Government & Identification Numbers</h5>
      <div class="form-grid">
        <div>
          <label>BP Number</label>
          <input type="text" name="bp_number" value="{{ employee.bp_number or '' }}">
        </div>
        <div>
          <label>PhilHealth Number</label>
          <input type="text" name="philhealth_number" value="{{ employee.philhealth_number or '' }}">
        </div>
        <div>
          <label>Pag-IBIG Number</label>
          <input type="text" name="pagibig_number" value="{{ employee.pagibig_number or '' }}">
        </div>
        <div>
          <label>TIN</label>
          <input type="text" name="tin" value="{{ employee.tin or '' }}">
        </div>
        <div>
          <label>ID Number</label>
          <input type="text" name="id_number" value="{{ employee.id_number or '' }}">
        </div>
      </div>
    </div>

    <!-- Employment Information -->
    <div class="register-card">
      <h5>Employment Information</h5>
      <div class="form-grid">
        <div>
          <label>Position</label>
          <input type="text" name="position" value="{{ employee.position or '' }}">
        </div>
        <div>
          <label>Salary Grade</label>
          <input type="text" name="salary_grade" value="{{ employee.salary_grade or '' }}">
        </div>
        <div>
          <label>Basic Salary</label>
          <input type="number" name="basic_salary" step="0.01" value="{{ employee.basic_salary or '' }}">
        </div>
        <div>
          <label>Department</label>
          <input type="text" name="department" value="{{ employee.department or '' }}">
        </div>
        <div>
          <label>Place of Assignment</label>
          <input type="text" name="place_of_assignment" value="{{ employee.place_of_assignment or '' }}">
        </div>
        <div>
          <label>Original Place of Assignment</label>
          <input type="text" name="original_place_of_assignment" value="{{ employee.original_place_of_assignment or '' }}">
        </div>
        <div>
          <label>Item Number</label>
          <input type="text" name="item_number" value="{{ employee.item_number or '' }}">
        </div>
      </div>
    </div>

    <!-- Appointment & Service Records -->
    <div class="register-card">
      <h5>Appointment & Service Records</h5>
      <div class="form-grid">
        <div>
          <label>Date Appointed</label>
          <input type="date" name="date_appointed" value="{{ employee.date_appointed or '' }}">
        </div>
        <div>
          <label>Date of Last Promotion</label>
          <input type="date" name="date_of_last_promotion" value="{{ employee.date_of_last_promotion or '' }}">
        </div>
        <div>
          <label>Date of Separation</label>
          <input type="date" name="date_of_separation" value="{{ employee.date_of_separation or '' }}">
        </div>
        <div>
          <label>Employment Status</label>
          <select name="employment_status">
            <option value="">Select</option>
            <option value="Permanent" {% if employee.employment_status == 'Permanent' %}selected{% endif %}>Permanent</option>
            <option value="Temporary" {% if employee.employment_status == 'Temporary' %}selected{% endif %}>Temporary</option>
            <option value="Contractual" {% if employee.employment_status == 'Contractual' %}selected{% endif %}>Contractual</option>
            <option value="Casual" {% if employee.employment_status == 'Casual' %}selected{% endif %}>Casual</option>
          </select>
        </div>
        <div>
          <label>Eligibility</label>
          <input type="text" name="eligibility" value="{{ employee.eligibility or '' }}">
        </div>
      </div>
    </div>

    <!-- Facial Capture (Optional - to update photo) -->
    <div class="register-card facial-capture-section">
      <h5>Update Photo (Optional)</h5>
      <p style="color: #6b7280; margin-bottom: 15px; font-size: 14px;">Leave empty to keep current photo</p>
      {% if employee.photo_path %}
      <div style="text-align: center; margin-bottom: 15px;">
        <p style="margin-bottom: 10px; font-weight: 600;">Current Photo:</p>
        <img src="{{ url_for('static', filename=employee.photo_path) }}" 
             alt="Current Photo" 
             style="width: 150px; height: 150px; object-fit: cover; border-radius: 8px; border: 2px solid #667eea;">
      </div>
      {% endif %}
      <div class="facial-capture-container">
        <div class="capture-slots">
          <div class="capture-slot" id="slot-0">
            <div class="slot-icon">✓</div>
          </div>
          <div class="capture-slot" id="slot-1">
            <div class="slot-icon">✓</div>
          </div>
          <div class="capture-slot" id="slot-2">
            <div class="slot-icon">✓</div>
          </div>
          <div class="capture-slot" id="slot-3">
            <div class="slot-icon">✓</div>
          </div>
          <div class="capture-slot" id="slot-4">
            <div class="slot-icon">✓</div>
          </div>
          <div class="capture-slot" id="slot-5">
            <div class="slot-icon">✓</div>
          </div>
        </div>
        <div class="camera-preview-container">
          <video id="videoPreview" autoplay playsinline style="display: none;"></video>
          <canvas id="captureCanvas" style="display: none;"></canvas>
          <div id="cameraPlaceholder" class="camera-placeholder">
            <p>Click "Capture Photo" to update photo</p>
          </div>
        </div>
        <button type="button" id="captureBtn" class="capture-photo-btn">Capture Photo</button>
      </div>
      <input type="hidden" name="face_images" id="faceImagesInput">
    </div>

    <!-- Submit Button -->
    <div class="register-actions">
      <button type="submit" class="register-submit-btn">Update Employee</button>
      <a href="{{ url_for('admin_employee_info', id=employee.id) }}" 
         class="btn-secondary" 
         style="padding: 12px 30px; text-decoration: none; display: inline-block; margin-left: 10px;">
        Cancel
      </a>
    </div>

    {% if error %}
    <div class="error-message" style="margin-top: 20px; padding: 15px; background: #fee; color: #c33; border-radius: 8px; border: 2px solid #c33; font-weight: 600;">
      <strong>⚠️ Update Failed:</strong> {{ error }}
    </div>
    {% endif %}
  </form>
</div>

<script>
let stream = null;
let capturedImages = [];
let currentSlot = 0;

const video = document.getElementById('videoPreview');
const canvas = document.getElementById('captureCanvas');
const captureBtn = document.getElementById('captureBtn');
const cameraPlaceholder = document.getElementById('cameraPlaceholder');
const faceImagesInput = document.getElementById('faceImagesInput');

// Start camera when Capture Photo button is clicked
captureBtn.addEventListener('click', async () => {
  if (stream) {
    capturePhoto();
  } else {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ 
        video: { 
          facingMode: 'user',
          width: { ideal: 640 },
          height: { ideal: 480 }
        } 
      });
      video.srcObject = stream;
      video.style.display = 'block';
      cameraPlaceholder.style.display = 'none';
      captureBtn.textContent = 'Capture Photo';
    } catch (error) {
      alert('Error accessing camera: ' + error.message);
      console.error('Camera error:', error);
    }
  }
});

function capturePhoto() {
  if (!stream) return;
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0);
  const imageData = canvas.toDataURL('image/jpeg', 0.8);
  
  if (currentSlot < 6) {
    capturedImages[currentSlot] = imageData;
    const slot = document.getElementById(`slot-${currentSlot}`);
    slot.classList.add('captured');
    slot.style.backgroundImage = `url(${imageData})`;
    slot.style.backgroundSize = 'cover';
    slot.style.backgroundPosition = 'center';
    currentSlot++;
    faceImagesInput.value = JSON.stringify(capturedImages.filter(img => img !== undefined));
    
    if (currentSlot >= 6) {
      stopCamera();
      captureBtn.textContent = 'All Photos Captured';
      captureBtn.disabled = true;
    }
  }
}

function stopCamera() {
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
    stream = null;
    video.style.display = 'none';
    cameraPlaceholder.style.display = 'block';
  }
}

document.getElementById('editForm').addEventListener('submit', () => {
  stopCamera();
});

window.addEventListener('beforeunload', () => {
  stopCamera();
});
</script>
{% endblock %}
